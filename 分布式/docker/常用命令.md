# 1. 安装Docker

参见[官网](https://docs.docker.com/install/linux/docker-ce/centos/#install-docker-ce)

```bash
yum install -y yum-utils \
  device-mapper-persistent-data \
  lvm2

yum-config-manager \
    --add-repo \
    https://download.docker.com/linux/centos/docker-ce.repo

yum install -y docker-ce
```

## 1.1. 设置阿里云镜像

针对Docker客户端版本大于 1.10.0 的用户

您可以通过修改daemon配置文件 `/etc/docker/daemon.json` 来使用加速器

```bash
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://3u6viwpg.mirror.aliyuncs.com"]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```

# 2. 启动MySQL

参见[docker-hub](https://hub.docker.com/_/mysql/)

``` bash
# 如果不需要配置自己的配置文件
docker run --name mysql -v /tmwl/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=TMwl2018~ -d -p 3306:3306 --restart=always mysql:5.7 --default-time-zone=+08:00 --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

# 如果需要配置自己的配置文件
docker run --name mysql -v /tmwl/mysql/data:/var/lib/mysql -v /tmwl/mysql/conf:/etc/mysql/conf.d -e MYSQL_ROOT_PASSWORD=TMwl2018~ -d -p 3306:3306 --restart=always mysql:5.7 --default-time-zone=+08:00 --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
```

# 启动Redis

参见[docker-hub](https://hub.docker.com/_/redis/)

``` bash
docker run --name redis -d --restart=always -p 6379:6379 -v /tmwl/redis/data:/data -v /tmwl/redis/config/redis.conf:/usr/local/etc/redis/redis.conf redis:4 redis-server /usr/local/etc/redis/redis.conf
```

# 启动gitlab

参见[docker-hub](https://hub.docker.com/r/gitlab/gitlab-ce/)

``` bash
docker run --detach \
	--hostname gitlab.tianmiwl.com \
    --env GITLAB_OMNIBUS_CONFIG="external_url 'http://gitlab.tianmiwl.com/';" \
	--env MAVEN_HOME="" \
	--env PATH="$MAVEN_HOME:$PATH" \
	--publish 8443:443 --publish 8082:80 --publish 822:22 \
	--name gitlab \
	--restart always \
	--volume /tmwl/tools/gitlab/config:/etc/gitlab:Z \
	--volume /tmwl/tools/gitlab/logs:/var/log/gitlab:Z \
	--volume /tmwl/tools/gitlab/data:/var/opt/gitlab:Z \
	gitlab/gitlab-ce:latest
```

等待jenkins启动完成后需要设置gitlab docker里的hosts文件，添加如下内容

```
# 这里的ip地址不能是局域网的ip地址
118.31.55.111     jenkins.tianmiwl.com
```



# 启动jenkins

参见[docker-hub](https://github.com/jenkinsci/docker/blob/master/README.md)

```bash
docker run --restart always -d -u root -p 8080:8080 -p 50000:50000 --name jenkins -v /tmwl/tools/jenkins:/var/jenkins_home --link gitlab:gitlab.tianmiwl.com --add-host nexus.tianmiwl.com:172.16.202.83 jenkins/jenkins:lts
```

# 启动nexus

# 启动zookeeper

参见 [docker-hub](https://hub.docker.com/_/zookeeper)。

## 单实例

```bash
docker run -d --name zookeeper --hostname zookeeper --restart always -p 2181:2181 -p 2888:2888 -p 3888:3888 -v /tmwl/zookeeper/data:/data -v /tmwl/zookeeper/datalog:/datalog -v /tmwl/zookeeper/logs:/logs -v /tmwl/zookeeper/config/zoo.cfg:/conf/zoo.cfg zookeeper:3.4
```

这个单实例只适用于开发、测试环境。这里的zoo.cfg配置如下

```properties
tickTime=2000
dataDir=/data
dataLogDir=/datalog
clientPort=2181
```

# 启动kafka

## 启动kafka-manager

参见 [docker-hub](https://hub.docker.com/r/sheepkiller/kafka-manager)。

```bash
docker run -d --restart always -p 9000:9000 --link zookeeper:zookeeper -e ZK_HOSTS="zookeeper:2181" -e APPLICATION_SECRET="tm2018" --name kafka-manager sheepkiller/kafka-manager
```

